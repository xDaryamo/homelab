apiVersion: v1
kind: ConfigMap
metadata:
  name: glance-config
  namespace: glance
data:
  glance.yml: |
    theme:
      background-color: 240, 0%, 94%
      primary-color: 0, 0%, 20%
      text-color: 0, 0%, 20%

    pages:
      - name: Home
        head-widgets:
          - type: custom-api
            title: Upcoming Events
            cache: 15m
            template: |
              {{
                $token := newRequest "https://oauth2.googleapis.com/token"
                  | withHeader "Content-Type" "application/x-www-form-urlencoded"
                  | withStringBody "client_id=${GOOGLE_CLIENT_ID}&client_secret=${GOOGLE_CLIENT_SECRET}&refresh_token=${GOOGLE_REFRESH_TOKEN}&grant_type=refresh_token"
                  | getResponse
              }}

              {{ if ne $token.Response.StatusCode 200 }}
                <p>Failed to get token: {{ $token.Response.Status }}</p>
              {{ else }}
                {{ $accessToken := $token.JSON.String "access_token" }}
                {{ $nowtime := now | formatTime "rfc3339" }}
                {{ $future := offsetNow "720h" | formatTime "rfc3339" }}
                {{
                  $events := newRequest "https://www.googleapis.com/calendar/v3/calendars/primary/events"
                    | withParameter "timeMin" $nowtime
                    | withParameter "timeMax" $future
                    | withParameter "singleEvents" "true"
                    | withParameter "orderBy" "startTime"
                    | withHeader "Authorization" (print "Bearer " $accessToken)
                    | getResponse
                }}

                {{ if ne $events.Response.StatusCode 200 }}
                  <p>Failed to fetch events: {{ $events.Response.Status }}</p>
                {{ else }}
                  <div>
                    {{ range $events.JSON.Array "items" }}
                    {{ $start := .String "start.dateTime" }}
                    {{ $end := .String "end.dateTime" }}
                    {{ $isAllDay := eq $start "" }}
                    {{ if $isAllDay }}
                      {{ $start = print (.String "start.date") | parseLocalTime "DateOnly" }}
                      {{ $end = print (.String "end.date") | parseLocalTime "DateOnly" }}
                    {{ else }}
                      {{ $start = $start | parseTime "rfc3339" }}
                      {{ $end = $end | parseTime "rfc3339" }}            
                    {{ end }}
                    {{ $startDateOnly := $start | formatTime "DateOnly" }}
                    {{ $endDateOnly := $end | formatTime "DateOnly" }}
                    {{ $isStartAndEndDateSame := eq $startDateOnly $endDateOnly }}

                    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start;">
                      <a href="https://calendar.google.com/calendar/u/0" target="_blank" class="size-h1" style="text-align: left; width: 215px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                        {{ .String "summary" }}
                      </a>
                      <a href="https://calendar.google.com/calendar/u/0" target="_blank" class="size-h3" style="text-align: left;">
                        {{ $start | formatTime "Mon, Jan 2 · 3:04 PM" }} 
                        {{ if $isStartAndEndDateSame }}
                            - {{ $end | formatTime "3:04 PM" }}
                          {{ else }}
                            - {{ $end | formatTime "Mon, Jan 2 · 3:04 PM" }}
                        {{ end }}
                      </a>
                      <div class="color-primary size-h3" style="text-align: right; width: 75px;" {{ $start | toRelativeTime }}>
                      </div>
                    </div>
                  {{ end }}
                  </div>
                {{ end }}
              {{ end }}

        columns:
          - size: small
            widgets:
              - type: calendar
                first-day-of-week: monday

              - type: custom-api
                title: Google Tasks
                cache: 15m
                template: |
                  {{
                    $token := newRequest "https://oauth2.googleapis.com/token"
                      | withHeader "Content-Type" "application/x-www-form-urlencoded"
                      | withStringBody "client_id=${GOOGLE_CLIENT_ID}&client_secret=${GOOGLE_CLIENT_SECRET}&refresh_token=${GOOGLE_REFRESH_TOKEN}&grant_type=refresh_token"
                      | getResponse
                  }}

                  {{ if ne $token.Response.StatusCode 200 }}
                    <p>Failed to get token: {{ $token.Response.Status }}</p>
                  {{ else }}
                    {{ $accessToken := $token.JSON.String "access_token" }}
                    {{
                      $tasks := newRequest "https://tasks.googleapis.com/tasks/v1/lists/@default/tasks"
                        | withParameter "showCompleted" "false"
                        | withParameter "maxResults" "10"
                        | withHeader "Authorization" (print "Bearer " $accessToken)
                        | getResponse
                    }}

                    {{ if ne $tasks.Response.StatusCode 200 }}
                      <p>Failed to fetch tasks: {{ $tasks.Response.Status }}</p>
                    {{ else }}
                      {{ $items := $tasks.JSON.Array "items" }}
                      {{ if eq (len $items) 0 }}
                        <p style="color: #d1d1d1;" class="size-h3">No tasks found</p>
                      {{ else }}
                        <div>
                          {{ $lastDate := "" }}
                          {{ $now := now }}
                          {{ $today := $now | formatTime "2006-01-02" }}
                          {{ $yesterday := offsetNow "-24h" | formatTime "2006-01-02" }}
                          {{ $tomorrow := offsetNow "24h" | formatTime "2006-01-02" }}

                          {{ range $items }}
                            {{ $due := .String "due" }}
                            {{ $currentDisplayGroup := "" }}

                            {{ if ne $due "" }}
                              {{ $dueTime := $due | parseTime "rfc3339" }}
                              {{ $dueDateStr := $dueTime | formatTime "2006-01-02" }}
                              {{ $currentDisplayGroup = $dueTime | formatTime "02/01" }}

                              {{ if eq $dueDateStr $today }}
                                {{ $currentDisplayGroup = "Today" }}
                              {{ else if eq $dueDateStr $yesterday }}
                                {{ $currentDisplayGroup = "Yesterday" }}
                              {{ else if eq $dueDateStr $tomorrow }}
                                {{ $currentDisplayGroup = "Tomorrow" }}
                              {{ end }}
                            {{ else }}
                              {{ $currentDisplayGroup = "No Date" }}
                            {{ end }}

                            {{ if ne $currentDisplayGroup $lastDate }}
                              {{ if ne $currentDisplayGroup "No Date" }}
                                <div class="color-primary size-h3" style="margin-top: 8px; margin-bottom: 4px;">
                                  {{ $currentDisplayGroup }}
                                </div>
                              {{ end }}
                              {{ $lastDate = $currentDisplayGroup }}
                            {{ end }}

                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                               <a href="https://tasks.google.com/embed/?origin=https://calendar.google.com" target="_blank" class="size-h3" style="text-align: left; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                                - {{ .String "title" }}
                              </a>
                            </div>
                          {{ end }}
                        </div>
                      {{ end }}
                    {{ end }}
                  {{ end }}

              - type: rss
                limit: 10

          - size: full
            widgets:
              - type: search
                autofocus: true

              - type: split-column
                max-columns: 3
                widgets:
                  - type: bookmarks
                    hide-header: true
                    groups:
                      - title: Google
                        icon: si:google
                        links:
                          - title: Gmail
                            url: https://mail.google.com
                            icon: si:gmail
                          - title: YouTube
                            url: https://youtube.com
                            icon: si:youtube
                          - title: Gemini
                            url: https://gemini.google.com
                            icon: si:googlegemini
                          - title: Keep
                            url: https://keep.google.com
                            icon: si:googlekeep

              - type: group
                widgets:
                  - type: hacker-news
                  - type: lobsters

              - type: videos
                channels:
                  - UCXuqSBlHAE6Xw-yeJA0Tunw # Linus Tech Tips
                  - UCR-DXc1voovS8nhAvccRZhg # Jeff Geerling
                  - UCsBjURrPoezykLs9EqgamOA # Fireship
                  - UCBJycsmduvYEL83R_U4JriQ # Marques Brownlee
                  - UCHnyfMqiRRG1u-2MsSQLbXA # Veritasium

              - type: group
                widgets:
                  - type: reddit
                    subreddit: technology
                    show-thumbnails: true
                  - type: reddit
                    subreddit: selfhosted
                    show-thumbnails: true

          - size: small
            widgets:
              - type: weather
                location: London, United Kingdom
                units: metric
                hour-format: 24h

              - type: markets
                markets:
                  - symbol: SPY
                    name: S&P 500
                  - symbol: BTC-USD
                    name: Bitcoin
                  - symbol: NVDA
                    name: NVIDIA
                  - symbol: AAPL
                    name: Apple
                  - symbol: MSFT
                    name: Microsoft

              - type: releases
                cache: 1d
                repositories:
                  - glanceapp/glance
                  - go-gitea/gitea
                  - immich-app/immich
                  - syncthing/syncthing