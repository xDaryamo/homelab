apiVersion: v1
kind: ConfigMap
metadata:
  name: glance-config
  namespace: glance
data:
  glance.yml: |
    theme:
      background-color: 240, 0%, 94%
      primary-color: 0, 0%, 20%
      text-color: 0, 0%, 20%

    pages:
      - name: Home
        head-widgets:
          - type: custom-api
            title: Upcoming Events
            cache: 15m
            template: |
              {{
                $token := newRequest "https://oauth2.googleapis.com/token"
                  | withHeader "Content-Type" "application/x-www-form-urlencoded"
                  | withStringBody "client_id=${GOOGLE_CLIENT_ID}&client_secret=${GOOGLE_CLIENT_SECRET}&refresh_token=${GOOGLE_REFRESH_TOKEN}&grant_type=refresh_token"
                  | getResponse
              }}

              {{ if ne $token.Response.StatusCode 200 }}
                <p>Failed to get token: {{ $token.Response.Status }}</p>
              {{ else }}
                {{ $accessToken := $token.JSON.String "access_token" }}
                {{ $nowtime := now | formatTime "rfc3339" }}
                {{ $future := offsetNow "720h" | formatTime "rfc3339" }}
                {{
                  $events := newRequest "https://www.googleapis.com/calendar/v3/calendars/primary/events"
                    | withParameter "timeMin" $nowtime
                    | withParameter "timeMax" $future
                    | withParameter "singleEvents" "true"
                    | withParameter "orderBy" "startTime"
                    | withHeader "Authorization" (print "Bearer " $accessToken)
                    | getResponse
                }}

                {{ if ne $events.Response.StatusCode 200 }}
                  <p>Failed to fetch events: {{ $events.Response.Status }}</p>
                {{ else }}
                  <div>
                    {{ range $events.JSON.Array "items" }}
                    {{ $start := .String "start.dateTime" }}
                    {{ $end := .String "end.dateTime" }}
                    {{ $isAllDay := eq $start "" }}
                    {{ if $isAllDay }}
                      {{ $start = print (.String "start.date") | parseLocalTime "DateOnly" }}
                      {{ $end = print (.String "end.date") | parseLocalTime "DateOnly" }}
                    {{ else }}
                      {{ $start = $start | parseTime "rfc3339" }}
                      {{ $end = $end | parseTime "rfc3339" }}            
                    {{ end }}
                    {{ $startDateOnly := $start | formatTime "DateOnly" }}
                    {{ $endDateOnly := $end | formatTime "DateOnly" }}
                    {{ $isStartAndEndDateSame := eq $startDateOnly $endDateOnly }}

                    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start;">
                      <a href="https://calendar.google.com/calendar/u/0" target="_blank" class="size-h1" style="text-align: left; width: 215px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                        {{ .String "summary" }}
                      </a>
                      <a href="https://calendar.google.com/calendar/u/0" target="_blank" class="size-h3" style="text-align: left;">
                        {{ $start | formatTime "Mon, Jan 2 · 3:04 PM" }} 
                        {{ if $isStartAndEndDateSame }}
                            - {{ $end | formatTime "3:04 PM" }}
                          {{ else }}
                            - {{ $end | formatTime "Mon, Jan 2 · 3:04 PM" }}
                        {{ end }}
                      </a>
                      <div class="color-primary size-h3" style="text-align: right; width: 75px;" {{ $start | toRelativeTime }}>
                      </div>
                    </div>
                  {{ end }}
                  </div>
                {{ end }}
              {{ end }}

        columns:
          - size: small
            widgets:
              - type: clock
                hour-format: 24h

              - type: calendar
                first-day-of-week: monday

              - type: custom-api
                title: Google Tasks
                cache: 15m
                template: |
                  {{
                    $token := newRequest "https://oauth2.googleapis.com/token"
                      | withHeader "Content-Type" "application/x-www-form-urlencoded"
                      | withStringBody "client_id=${GOOGLE_CLIENT_ID}&client_secret=${GOOGLE_CLIENT_SECRET}&refresh_token=${GOOGLE_REFRESH_TOKEN}&grant_type=refresh_token"
                      | getResponse
                  }}

                  {{ if ne $token.Response.StatusCode 200 }}
                    <p>Failed to get token: {{ $token.Response.Status }}</p>
                  {{ else }}
                    {{ $accessToken := $token.JSON.String "access_token" }}
                    {{
                      $tasks := newRequest "https://tasks.googleapis.com/tasks/v1/lists/@default/tasks"
                        | withParameter "showCompleted" "false"
                        | withParameter "maxResults" "10"
                        | withHeader "Authorization" (print "Bearer " $accessToken)
                        | getResponse
                    }}

                    {{ if ne $tasks.Response.StatusCode 200 }}
                      <p>Failed to fetch tasks: {{ $tasks.Response.Status }}</p>
                    {{ else }}
                      {{ $items := $tasks.JSON.Array "items" }}
                      {{ if eq (len $items) 0 }}
                        <p style="color: #d1d1d1;" class="size-h3">No tasks found</p>
                      {{ else }}
                        <div>
                          {{ $lastDate := "" }}
                          {{ $now := now }}
                          {{ $today := $now | formatTime "2006-01-02" }}
                          {{ $yesterday := offsetNow "-24h" | formatTime "2006-01-02" }}
                          {{ $tomorrow := offsetNow "24h" | formatTime "2006-01-02" }}

                          {{ range $items }}
                            {{ $due := .String "due" }}
                            {{ $currentDisplayGroup := "" }}

                            {{ if ne $due "" }}
                              {{ $dueTime := $due | parseTime "rfc3339" }}
                              {{ $dueDateStr := $dueTime | formatTime "2006-01-02" }}
                              {{ $currentDisplayGroup = $dueTime | formatTime "02/01" }}

                              {{ if eq $dueDateStr $today }}
                                {{ $currentDisplayGroup = "Today" }}
                              {{ else if eq $dueDateStr $yesterday }}
                                {{ $currentDisplayGroup = "Yesterday" }}
                              {{ else if eq $dueDateStr $tomorrow }}
                                {{ $currentDisplayGroup = "Tomorrow" }}
                              {{ end }}
                            {{ else }}
                              {{ $currentDisplayGroup = "No Date" }}
                            {{ end }}

                            {{ if ne $currentDisplayGroup $lastDate }}
                              {{ if ne $currentDisplayGroup "No Date" }}
                                <div class="color-primary size-h3" style="margin-top: 8px; margin-bottom: 4px;">
                                  {{ $currentDisplayGroup }}
                                </div>
                              {{ end }}
                              {{ $lastDate = $currentDisplayGroup }}
                            {{ end }}

                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                               <a href="https://tasks.google.com/embed/?origin=https://calendar.google.com" target="_blank" class="size-h3" style="text-align: left; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                                - {{ .String "title" }}
                              </a>
                            </div>
                          {{ end }}
                        </div>
                      {{ end }}
                    {{ end }}
                  {{ end }}


          - size: full
            widgets:
              - type: search
                autofocus: true

              - type: split-column
                max-columns: 3
                widgets:
                  - type: bookmarks
                    hide-header: true
                    groups:
                      - title: Apps
                        links:
                          - title: Gmail
                            url: https://mail.google.com
                            icon: si:gmail
                          - title: YouTube
                            url: https://youtube.com
                            icon: si:youtube
                          - title: WhatsApp
                            url: https://web.whatsapp.com
                            icon: si:whatsapp
                          - title: Gemini
                            url: https://gemini.google.com
                            icon: si:googlegemini
                          - title: Keep
                            url: https://keep.google.com
                            icon: si:googlekeep

              - type: rss
                title: NEWS
                collapse-after: 3
                limit: 10
                cache: 1h
                feeds:
                  - url: https://www.ansa.it/sito/ansait_rss.xml
                    title: ANSA
                  - url: https://www.ilsole24ore.com/rss/mondo.xml
                    title: Il Sole 24 Ore

              - type: videos
                channels:
                  - UC4V3oCikXeSqYQr0hBMARwg # Breaking Italy
                  - UCHnyfMqiRRG1u-2MsSQLbXA # Veritasium
                  - UCBJycsmduvYEL83R_U4JriQ # Marques Brownlee
                  - UCHi6Q3Z-5oJUC691WLlSntA # Barbascura Extra
                  - UCCnqSU06KXxGvPESASofSQA # Paolo Coletti

              - type: group
                widgets:
                  - type: reddit
                    subreddit: damnthatsinteresting
                    show-thumbnails: true
                  - type: reddit
                    subreddit: internetisbeautiful
                    show-thumbnails: true

          - size: small
            widgets:
              - type: weather
                location: Torre del Greco, Italy
                units: metric
                hour-format: 24h

              - type: markets
                markets:
                  - symbol: SPY
                    name: S&P 500
                  - symbol: BTC-USD
                    name: Bitcoin
                  - symbol: NVDA
                    name: NVIDIA
                  - symbol: AAPL
                    name: Apple
                  - symbol: MSFT
                    name: Microsoft

      - name: Homelab
        columns:
          - size: small
            widgets:
              - type: server-stats
                servers:
                  - type: remote
                    name: Control Plane
                    url: http://192.168.1.24:27973
                    hide-swap: true
                  - type: remote
                    name: Worker Primary
                    url: http://192.168.1.25:27973
                    hide-swap: true
                  - type: remote
                    name: Worker Secondary
                    url: http://192.168.1.26:27973
                    hide-swap: true
              - type: repository
                repository: xDaryamo/homelab
          - size: full
            widgets:
              - type: custom-api
                title: Cluster Overview
                cache: 1m
                url: http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090/api/v1/query?query=1%20-%20sum(node_memory_MemAvailable_bytes)%20/%20sum(node_memory_MemTotal_bytes)
                subrequests:
                  cpu:
                    url: http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090/api/v1/query?query=avg(1%20-%20rate(node_cpu_seconds_total%7Bmode=%22idle%22%7D%5B5m%5D))
                template: |
                  <div class="flex justify-between text-center">
                    <div>
                        <div class="color-highlight size-h3">{{ mul (.JSON.String "data.result.0.value.1" | toFloat) 100 | printf "%.1f" }}%</div>
                        <div class="size-h6">RAM USAGE</div>
                    </div>
                    <div>
                        <div class="color-highlight size-h3">{{ mul ((.Subrequest "cpu").JSON.String "data.result.0.value.1" | toFloat) 100 | printf "%.1f" }}%</div>
                        <div class="size-h6">CPU USAGE</div>
                    </div>
                  </div>
              - type: releases
                repositories:
                  - xDaryamo/homelab
                  - kubernetes/kubernetes
                  - fluxcd/flux2
                  - renovatebot/renovate
                  - cilium/cilium
                  - cert-manager/cert-manager
                  - longhorn/longhorn
          - size: small
            widgets:
              - type: monitor
                title: Active Services
                sites:
                  - title: Portfolio
                    url: https://dariomazza.net
                  - title: Podinfo
                    url: https://podinfo.dariomazza.net
                  - title: Homepage
                    url: https://dashboard-inner.dariomazza.net
                  - title: Longhorn
                    url: https://longhorn.dariomazza.net
                  - title: Glance
                    url: https://home.dariomazza.net
