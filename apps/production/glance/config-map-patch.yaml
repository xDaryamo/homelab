apiVersion: v1
kind: ConfigMap
metadata:
  name: glance-config
  namespace: glance
data:
  glance.yml: |
    theme:
      background-color: 240, 0%, 94%
      primary-color: 0, 0%, 20%
      text-color: 0, 0%, 20%

    pages:
      - name: Home
        head-widgets:
          - type: custom-api
            title: Upcoming Events
            cache: 15m
            template: |
              {{
                $token := newRequest "https://oauth2.googleapis.com/token"
                  | withHeader "Content-Type" "application/x-www-form-urlencoded"
                  | withStringBody "client_id=${GOOGLE_CLIENT_ID}&client_secret=${GOOGLE_CLIENT_SECRET}&refresh_token=${GOOGLE_REFRESH_TOKEN}&grant_type=refresh_token"
                  | getResponse
              }}

              {{ if ne $token.Response.StatusCode 200 }}
                <p>Failed to get token: {{ $token.Response.Status }}</p>
              {{ else }}
                {{ $accessToken := $token.JSON.String "access_token" }}
                {{ $nowtime := now | formatTime "rfc3339" }}
                {{ $future := offsetNow "720h" | formatTime "rfc3339" }}
                {{
                  $events := newRequest "https://www.googleapis.com/calendar/v3/calendars/primary/events"
                    | withParameter "timeMin" $nowtime
                    | withParameter "timeMax" $future
                    | withParameter "singleEvents" "true"
                    | withParameter "orderBy" "startTime"
                    | withHeader "Authorization" (print "Bearer " $accessToken)
                    | getResponse
                }}

                {{ if ne $events.Response.StatusCode 200 }}
                  <p>Failed to fetch events: {{ $events.Response.Status }}</p>
                {{ else }}
                  <div>
                    {{ range $events.JSON.Array "items" }}
                    {{ $start := .String "start.dateTime" }}
                    {{ $end := .String "end.dateTime" }}
                    {{ $isAllDay := eq $start "" }}
                    {{ if $isAllDay }}
                      {{ $start = print (.String "start.date") | parseLocalTime "DateOnly" }}
                      {{ $end = print (.String "end.date") | parseLocalTime "DateOnly" }}
                    {{ else }}
                      {{ $start = $start | parseTime "rfc3339" }}
                      {{ $end = $end | parseTime "rfc3339" }}            
                    {{ end }}
                    {{ $startDateOnly := $start | formatTime "DateOnly" }}
                    {{ $endDateOnly := $end | formatTime "DateOnly" }}
                    {{ $isStartAndEndDateSame := eq $startDateOnly $endDateOnly }}

                    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start;">
                      <a href="https://calendar.google.com/calendar/u/0" target="_blank" class="size-h1" style="text-align: left; width: 215px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                        {{ .String "summary" }}
                      </a>
                      <a href="https://calendar.google.com/calendar/u/0" target="_blank" class="size-h3" style="text-align: left;">
                        {{ $start | formatTime "Mon, Jan 2 · 3:04 PM" }} 
                        {{ if $isStartAndEndDateSame }}
                            - {{ $end | formatTime "3:04 PM" }}
                          {{ else }}
                            - {{ $end | formatTime "Mon, Jan 2 · 3:04 PM" }}
                        {{ end }}
                      </a>
                      <div class="color-primary size-h3" style="text-align: right; width: 75px;" {{ $start | toRelativeTime }}>
                      </div>
                    </div>
                  {{ end }}
                  </div>
                {{ end }}
              {{ end }}

        columns:
          - size: small
            widgets:
              - type: clock
                hour-format: 24h

              - type: calendar
                first-day-of-week: monday

              - type: custom-api
                title: Google Tasks
                cache: 15m
                template: |
                  {{
                    $token := newRequest "https://oauth2.googleapis.com/token"
                      | withHeader "Content-Type" "application/x-www-form-urlencoded"
                      | withStringBody "client_id=${GOOGLE_CLIENT_ID}&client_secret=${GOOGLE_CLIENT_SECRET}&refresh_token=${GOOGLE_REFRESH_TOKEN}&grant_type=refresh_token"
                      | getResponse
                  }}

                  {{ if ne $token.Response.StatusCode 200 }}
                    <p>Failed to get token: {{ $token.Response.Status }}</p>
                  {{ else }}
                    {{ $accessToken := $token.JSON.String "access_token" }}
                    {{
                      $tasks := newRequest "https://tasks.googleapis.com/tasks/v1/lists/@default/tasks"
                        | withParameter "showCompleted" "false"
                        | withParameter "maxResults" "10"
                        | withHeader "Authorization" (print "Bearer " $accessToken)
                        | getResponse
                    }}

                    {{ if ne $tasks.Response.StatusCode 200 }}
                      <p>Failed to fetch tasks: {{ $tasks.Response.Status }}</p>
                    {{ else }}
                      {{ $items := $tasks.JSON.Array "items" }}
                      {{ if eq (len $items) 0 }}
                        <p style="color: #d1d1d1;" class="size-h3">No tasks found</p>
                      {{ else }}
                        <div>
                          {{ $lastDate := "" }}
                          {{ $now := now }}
                          {{ $today := $now | formatTime "2006-01-02" }}
                          {{ $yesterday := offsetNow "-24h" | formatTime "2006-01-02" }}
                          {{ $tomorrow := offsetNow "24h" | formatTime "2006-01-02" }}

                          {{ range $items }}
                            {{ $due := .String "due" }}
                            {{ $currentDisplayGroup := "" }}

                            {{ if ne $due "" }}
                              {{ $dueTime := $due | parseTime "rfc3339" }}
                              {{ $dueDateStr := $dueTime | formatTime "2006-01-02" }}
                              {{ $currentDisplayGroup = $dueTime | formatTime "02/01" }}

                              {{ if eq $dueDateStr $today }}
                                {{ $currentDisplayGroup = "Today" }}
                              {{ else if eq $dueDateStr $yesterday }}
                                {{ $currentDisplayGroup = "Yesterday" }}
                              {{ else if eq $dueDateStr $tomorrow }}
                                {{ $currentDisplayGroup = "Tomorrow" }}
                              {{ end }}
                            {{ else }}
                              {{ $currentDisplayGroup = "No Date" }}
                            {{ end }}

                            {{ if ne $currentDisplayGroup $lastDate }}
                              {{ if ne $currentDisplayGroup "No Date" }}
                                <div class="color-primary size-h3" style="margin-top: 8px; margin-bottom: 4px;">
                                  {{ $currentDisplayGroup }}
                                </div>
                              {{ end }}
                              {{ $lastDate = $currentDisplayGroup }}
                            {{ end }}

                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                               <a href="https://tasks.google.com/embed/?origin=https://calendar.google.com" target="_blank" class="size-h3" style="text-align: left; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                                - {{ .String "title" }}
                              </a>
                            </div>
                          {{ end }}
                        </div>
                      {{ end }}
                    {{ end }}
                  {{ end }}


          - size: full
            widgets:
              - type: search
                autofocus: true

              - type: split-column
                max-columns: 3
                widgets:
                  - type: bookmarks
                    groups:
                      - links:
                          - title: Gmail
                            url: https://mail.google.com
                            icon: sh:gmail
                          - title: YouTube
                            url: https://youtube.com
                            icon: sh:youtube
                      - links:
                          - title: WhatsApp
                            url: https://web.whatsapp.com
                            icon: sh:whatsapp
                          - title: Gemini
                            url: https://gemini.google.com
                            icon: sh:google-gemini
                      - links:
                          - title: Keep
                            url: https://keep.google.com
                            icon: sh:google-keep
                          - title: Linkedin
                            url: https://linkedin.com
                            icon: sh:linkedin

              - type: rss
                title: NEWS
                collapse-after: 3
                limit: 10
                cache: 1h
                feeds:
                  - url: https://www.ansa.it/sito/ansait_rss.xml
                    title: ANSA
                  - url: https://www.ilsole24ore.com/rss/mondo.xml
                    title: Il Sole 24 Ore

              - type: videos
                channels:
                  - UC4V3oCikXeSqYQr0hBMARwg # Breaking Italy
                  - UCHnyfMqiRRG1u-2MsSQLbXA # Veritasium
                  - UCBJycsmduvYEL83R_U4JriQ # Marques Brownlee
                  - UCHi6Q3Z-5oJUC691WLlSntA # Barbascura Extra
                  - UCCnqSU06KXxGvPESASofSQA # Paolo Coletti

              - type: group
                widgets:
                  - type: reddit
                    subreddit: damnthatsinteresting
                    show-thumbnails: true
                  - type: reddit
                    subreddit: internetisbeautiful
                    show-thumbnails: true

          - size: small
            widgets:
              - type: weather
                location: Torre del Greco, Italy
                units: metric
                hour-format: 24h

              - type: markets
                markets:
                  - symbol: SPY
                    name: S&P 500
                  - symbol: BTC-USD
                    name: Bitcoin
                  - symbol: NVDA
                    name: NVIDIA
                  - symbol: AAPL
                    name: Apple
                  - symbol: MSFT
                    name: Microsoft

      - name: Homelab
        columns:
          - size: small
            widgets:
              - type: server-stats
                servers:
                  - type: remote
                    name: Control Plane
                    url: http://192.168.1.24:27973
                    hide-swap: true
                  - type: remote
                    name: Worker Primary
                    url: http://192.168.1.25:27973
                    hide-swap: true
                  - type: remote
                    name: Worker Secondary
                    url: http://192.168.1.26:27973
                    hide-swap: true
              

          - size: full
            widgets:
              - type: monitor
                cache: 1m
                title: Services
                sites:
                  - title: Cloudflared
                    url: http://cloudflared.cloudflared.svc.cluster.local:2000/ready
                    icon: sh:cloudflare
                  - title: Portfolio
                    url: https://dariomazza.net/
                    icon: si:astro
                  - title: Longhorn
                    url: https://longhorn.dariomazza.net
                    icon: di:longhorn
                  - title: Grafana
                    url: https://grafana.dariomazza.net
                    icon: sh:grafana
                  - title: Glance
                    url: https://home.dariomazza.net
                    icon: sh:glance
                  - title: Jellyfin
                    url: https://jellyfin.dariomazza.net/
                    icon: sh:jellyfin
                
              - type: bookmarks
                groups:
                  - links:
                      - title: Cloudflare Dashboard
                        url: https://dash.cloudflare.com/
                        icon: sh:cloudflare
                  - links:
                      - title: Fritz!Box
                        url: http://192.168.1.1
                        icon: si:fritz
        
              - type: group
                widgets:
                  - type: reddit
                    subreddit: selfhosted
                    show-thumbnails: true
                  - type: reddit
                    subreddit: homelab
                    show-thumbnails: true
                  - type: reddit
                    subreddit: kubernetes
                    show-thumbnails: true

              - type: videos
                title: Homelab Media
                channels:
                  - UCgdTVe88YVSrOZ9qKumhULQ # Hardware Haven
                  - UCDAck-gFPTrgTx_qp59-bQA # Mischa van den Burg
                  - UCjSEJkpGbcZhvo0lr-44X_w # TechHut
            
          - size: small
            widgets:
              - type: repository
                repository: xDaryamo/homelab
                token: ${GITHUB_TOKEN}
              - type: repository
                repository: xDaryamo/private-homelab
                token: ${GITHUB_TOKEN}


      - name: Gaming
        columns:
          - size: small
            widgets:
              - type: custom-api
                title: Epic Games
                cache: 1h
                url: https://store-site-backend-static.ak.epicgames.com/freeGamesPromotions?locale=it&country=IT&allowCountries=IT
                template: |
                  <div>
                    {{ if eq .Response.StatusCode 200 }}
                      <div class="horizontal-cards-2">
                        {{ range .JSON.Array "data.Catalog.searchStore.elements" }}
                          {{ $price := .String "price.totalPrice.discountPrice" }}
                          {{ $hasPromo := gt (len (.Array "promotions.promotionalOffers")) 0 }}
                          {{ if and $hasPromo (eq $price "0") }}
                            {{ $gamePage := .String "productSlug" }}
                            {{ if gt (len (.Array "offerMappings")) 0 }}
                              {{ $gamePage = .String "offerMappings.0.pageSlug" }}
                            {{end }}
                            <a href="https://store.epicgames.com/it-IT/p/{{ $gamePage }}" target="_blank" class="card">
                              {{ $title := .String "title" }}
                              {{ range .Array "keyImages" }}
                                {{ if eq (.String "type") "OfferImageWide" }}
                                  <img src="{{ .String "url" }}" alt="{{ $title }}" style="width: 100%; max-width: 300px; height: 150px; object-fit: cover; border-radius: var(--border-radius);">
                                {{ end }}
                              {{ end }}
                              <div class="card-content">
                                <span class="size-base color-primary">{{ $title }}</span><br>
                                <span class="size-h5 color-subdue">
                                  {{ if $hasPromo }}
                                    {{ $promotions := .Array "promotions.promotionalOffers" }}
                                    {{ if gt (len $promotions) 0 }}
                                      {{ $firstPromo := index $promotions 0 }}
                                      {{ $offers := $firstPromo.Array "promotionalOffers" }}
                                      {{ if gt (len $offers) 0 }}
                                        {{ $firstOffer := index $offers 0 }}
                                        Free until {{ slice ($firstOffer.String "endDate") 0 10 }}
                                      {{ else }}
                                        Free this week!
                                      {{ end }}
                                    {{ else }}
                                      Free this week!
                                    {{ end }}
                                  {{ end }}
                                </span>
                              </div>
                            </a>
                          {{ end }}
                        {{ end }}
                      </div>
                    {{ else }}
                      <p class="color-negative">Error fetching Epic Games data.</p>
                    {{ end }}
                  </div>
              
              - type: custom-api
                title: Games in Sale
                cache: 12h
                url: https://store.steampowered.com/api/featuredcategories?cc=nl
                template: |
                  <ul class="list list-gap-10 collapsible-contain">
                      {{ $count := 0 }}
                      {{ range .JSON.Array "specials.items" }}
                      {{ if and (lt $count 6) (ne (.String "name") "Steam Deck") }}
                      <li style="display: flex; align-items: center; gap: 1rem;">
                          <img src="{{ .String "small_capsule_image" }}" alt="{{ .String "name" }}"
                              style="width: 120px; height: auto; border-radius: 4px; flex-shrink: 0;">
                          <div style="min-width: 0;">
                              <a class="size-h4 color-highlight text-truncate" style="display: block;"
                                  href="https://store.steampowered.com/app/{{ .Int "id" }}/">
                                  {{ .String "name" }}
                              </a>
                              <ul class="list-horizontal-text">
                                  <li>{{ div (.Int "final_price" | toFloat) 100 | printf "€%.2f" }}</li>
                                  {{ $discount := .Int "discount_percent" }}
                                  {{ if gt $discount 0 }}
                                  <li{{ if ge $discount 40 }} class="color-positive"{{ end }}>
                                      {{ $discount }}% off
                                  </li>
                                  {{ end }}
                              </ul>
                          </div>
                      </li>
                      {{ $count = add $count 1 }}
                      {{ end }}
                      {{ end }}
                  </ul>

              - type: custom-api
                title: Steam Top Sellers
                cache: 12h
                url: https://store.steampowered.com/api/featuredcategories?cc=it
                template: |
                  <ul class="list list-gap-10 collapsible-contain" data-collapse-after="15">
                      {{ range .JSON.Array "top_sellers.items" }}
                      {{ if ne (.String "name") "Steam Deck" }}
                      <li style="display: flex; align-items: center; gap: 1rem;">
                          <img src="{{ .String "small_capsule_image" }}" alt="{{ .String "name" }}"
                              style="width: 120px; height: auto; border-radius: 4px; flex-shrink: 0;">
                          <div style="min-width: 0;">
                              <a class="size-h4 color-highlight text-truncate" style="display: block;"
                                  href="https://store.steampowered.com/app/{{ .Int "id" }}/">
                                  {{ .String "name" }}
                              </a>
                              <ul class="list-horizontal-text">
                                  <li>{{ div (.Int "final_price" | toFloat) 100 | printf "$%.2f" }}</li>
                                  {{ $discount := .Int "discount_percent" }}
                                  {{ if gt $discount 0 }}
                                  <li{{ if ge $discount 40 }} class="color-positive" {{ end }}>
                                      {{ $discount }}% off
                      </li>
                      {{ end }}
                  </ul>
                  </div>
                  </li>
                  {{ end }}
                  {{ end }}
                  </ul>

          - size: full
            widgets:
              - type: videos
                style: grid-cards
                collapse-after-rows: 2
                channels:
                  - UCejoRVlol8IE09HNfUy8n2w 
                  - UCevDcbuoHr38ZT5gBsrtQXw 
                  - UC6NpRkanSBgQVdPZs_y3aKg 
                  - UCMxsVULY_qsk_aNdAqzcNUA 
                  - UCXq1mKz6bM8V5w5h3yX0b9w 
                  - UCpF62eV02XJpqJxBZAcsDCw
                  - UCHI2P8NSEkqKlzQ2osolWig

              - type: group
                widgets:
                  - type: reddit
                    show-thumbnails: true
                    subreddit: DBZDokkanBattle 
                  - type: reddit
                    show-thumbnails: true
                    subreddit: ArcRaiders
                  - type: reddit
                    show-thumbnails: true
                    subreddit: Games


          - size: small
            widgets:
              - type: custom-api
                title: Steam User
                cache: 1h
                url: https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${STEAM_API_KEY}&steamids=${STEAM_USER}
                template: |
                  <div class="steam-user-stats" style="display: flex; align-items: flex-start;">
                    {{ $players := .JSON.Array "response.players" }}
                    {{ if gt (len $players) 0 }}
                      {{ $player := index $players 0 }}
                      <div style="flex-shrink: 0; margin-right: 1em; display: flex; flex-direction: column; align-items: center;">
                        <a href="{{ $player.String "profileurl" }}"><img src="{{ $player.String "avatarmedium" }}" alt="Avatar" style="border-radius: var(--border-radius);"></a>
                      </div>
                      <div>
                        <h2 class="size-h3 color-primary">{{ $player.String "personaname" }}</h2>
                        <p>Status: 
                          {{ $status := $player.Int "personastate" }}
                          {{ if eq $status 0 }}<span class="color-negative">Offline</span>{{ end }}
                          {{ if eq $status 1 }}<span class="color-positive">Online</span>{{ end }}
                          {{ if eq $status 2 }}<span class="color-highlight">Busy</span>{{ end }}
                          {{ if eq $status 3 }}<span class="color-subdue">Away</span>{{ end }}
                          {{ if eq $status 4 }}<span class="color-subdue">Snooze</span>{{ end }}
                          {{ if eq $status 5 }}<span class="color-primary">Looking to trade</span>{{ end }}
                          {{ if eq $status 6 }}<span class="color-primary">Looking to play</span>{{ end }}
                        </p>
                        <p>Last Logoff: <span class="color-subdue" data-dynamic-relative-time="{{ $player.Int "lastlogoff" }}"></span></p>
                        <p>Account Created: <span class="color-subdue" data-dynamic-relative-time="{{ $player.Int "timecreated" }}"></span></p>
                        <p>Country: <span class="color-subdue">{{ $player.String "loccountrycode" }}</span></p>
                      </div>
                    {{ else }}
                      <p class="color-negative">No player data found.</p>
                    {{ end }}
                  </div>

              - type: custom-api
                title: Recently Played Games
                cache: 1h
                url: http://api.steampowered.com/IPlayerService/GetRecentlyPlayedGames/v0001/?key=${STEAM_API_KEY}&steamid=${STEAM_USER}&format=json
                template: |
                  <div>
                    {{ if eq .Response.StatusCode 200 }}
                      {{ $games := .JSON.Array "response.games" }}
                      {{ if gt (len $games) 0 }}
                        <ul class="list list-gap-10 collapsible-container" data-collapse-after="5">
                          {{ range $games }}
                            <li style="display: flex; align-items: center;">
                              <a href="https://store.steampowered.com/app/{{ .Int "appid" }}" target="_blank">
                                <img
                                  src="http://media.steampowered.com/steamcommunity/public/images/apps/{{ .Int "appid" }}/{{ .String "img_icon_url" }}.jpg"
                                  alt="{{ .String "name" }}"
                                  style="width: 32px; border-radius: var(--border-radius); margin-right: 10px;">
                              </a>
                              <div>
                                <a
                                  href="https://store.steampowered.com/app/{{ .Int "appid" }}"
                                  class="size-base color-primary"
                                  target="_blank"
                                >
                                  {{ .String "name" }}
                                </a>
                                <br>
                                <span class="size-h5 color-subdue">
                                  Last 2 weeks: 
                                  {{ if gt (toFloat (.Int "playtime_2weeks")) 60.0 }}
                                    {{ printf "%.2f hrs" (div (toFloat (.Int "playtime_2weeks")) 60.0) }}
                                  {{ else }}
                                    {{ .Int "playtime_2weeks" }} mins
                                  {{ end }}
                                </span>
                              </div>
                            </li>
                          {{ end }}
                        </ul>
                      {{ else }}
                        <p class="color-negative">No recently played games found.</p>
                      {{ end }}
                    {{ else }}
                      <p class="color-negative">An unexpected error occurred. Please try again later.</p>
                    {{ end }}
                  </div> 


              - type: twitch-top-games
                hide-header: true          
                limit: 20
                collapse-after: 5
                exclude:
                  - just-chatting
                  - pools-hot-tubs-and-beaches
                  - music
                  - art
                  - asmr